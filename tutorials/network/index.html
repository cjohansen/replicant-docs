<!DOCTYPE html><html data-theme="dark" lang="en" prefix="og: http://ogp.me/ns#"><head><title>Backend APIs and network</title><meta name="theme-color" content="#202020"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta property="og:title" content="Backend APIs and network"><link href="/a00f586d252b/favicon.ico" rel="icon" type="image/x-icon"><link href="/a00f586d252b/favicon.ico" rel="shortcut icon" type="image/ico"><link href="/a00f586d252b/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/a00f586d252b/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon"><link href="/285191ad6a81/apple-touch-icon.png" rel="icon" type="image/png" sizes="180x180"><link rel="stylesheet" href="/bundles/2e8dfb3c3384/styles.css"></head><body><div class="flex justify-between p-4 items-center"><div class="w-8"><a href="/"><svg style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2" viewBox="0 0 1080 1080" xml:space="preserve"><path d="M876.452 152.555c136.818 12.348 195.668 81.688 192.708 196.198h-87.197c1.569-66.295-16.004-119.066-52.748-157.356-14.398-15.003-31.913-27.882-52.763-38.353v-.489Zm98.715 270.164h87.213c-9.48 55.52-38.53 92.323-91.749 108.344 55.789 39.542 76.849 90.867 66.189 152.957l-44.388 184.981h-86.379l42.751-178.151c.149-.622.278-1.249.386-1.879 9.983-58.16-3.188-108.49-41.722-150.197 36.949-23.921 58.758-61.19 67.282-111.131a29.34 29.34 0 0 0 .417-4.924Z" fill="#4fb348"></path><path d="M757.149 152.309c138.837 11.646 198.514 81.149 195.537 196.444h-88.511c1.643-69.4-17.651-123.977-58.046-162.647-13.679-13.096-29.954-24.431-48.98-33.797Zm101.023 270.41h87.726c-9.475 55.52-38.529 92.323-91.745 108.344 55.785 39.542 76.848 90.867 66.191 152.957l-44.391 184.981h-87.689l42.752-178.151c.149-.622.278-1.249.386-1.879 9.983-58.16-3.188-108.49-41.722-150.197 36.948-23.921 58.758-61.19 67.281-111.131.153-.894.263-1.79.332-2.685h.506c.126-.747.25-1.493.373-2.239Z" fill="#00a29a"></path><path d="M76.208 847.157c-36.752-5.562-64.959-37.32-64.959-75.614 0-42.21 34.269-76.478 76.478-76.478a76.45 76.45 0 0 1 20.676 2.832c32.178 9.028 55.802 38.6 55.802 73.646 0 42.209-34.268 76.478-76.478 76.478-3.915 0-7.761-.295-11.519-.864Zm56.524-262.05a77.324 77.324 0 0 1-6.804.299c-42.209 0-76.478-34.268-76.478-76.478 0-42.209 34.269-76.478 76.478-76.478 13.663 0 26.494 3.591 37.6 9.879 23.204 13.139 38.878 38.053 38.878 66.599 0 39.917-30.647 72.732-69.674 76.179Zm-18.148 84.136 11.77-54.569c58.168-.23 105.321-47.525 105.321-105.746 0-35.555-17.586-67.035-44.526-86.209H828.11c-9.475 55.52-38.529 92.323-91.745 108.344 55.784 39.542 76.848 90.867 66.191 152.957l-44.391 184.981H539.756l34.836-151.189c13.135-57.004-4.455-118.062-91.882-118.062H353.796l-71.217 274.677H112.245c46.557-11.07 81.229-52.96 81.229-102.884 0-49.085-33.515-90.403-78.89-102.3Zm-1.803-330.67 117.483-187.485h389.845c152.584 6.696 217.9 77.175 214.789 197.665H178.595v-10.18h-65.814Z" fill="#0086ff"></path></svg></a></div><div class="flex items-center gap-4 text-sm"><a class="hover:underline" href="/learn/">Learn</a><a class="hover:underline" href="https://cljdoc.org/d/no.cjohansen/replicant/">API Reference</a><div class="w-6"><a href="https://clojurians.slack.com/archives/C06JZ4X334N" title="Replicant on the Clojurians Slack"><svg style="display: inline-block; line-height: 1;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><path d="M80,56h24a0,0,0,0,1,0,0v72a24,24,0,0,1-24,24h0a24,24,0,0,1-24-24V80A24,24,0,0,1,80,56Z" transform="translate(184 24) rotate(90)" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M128,80H104A24,24,0,0,1,80,56h0a24,24,0,0,1,24-24h0a24,24,0,0,1,24,24Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M152,32h24a0,0,0,0,1,0,0v72a24,24,0,0,1-24,24h0a24,24,0,0,1-24-24V56a24,24,0,0,1,24-24Z" transform="translate(304 160) rotate(-180)" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M176,128V104a24,24,0,0,1,24-24h0a24,24,0,0,1,24,24h0a24,24,0,0,1-24,24Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M176,104h24a0,0,0,0,1,0,0v72a24,24,0,0,1-24,24h0a24,24,0,0,1-24-24V128a24,24,0,0,1,24-24Z" transform="translate(24 328) rotate(-90)" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M128,176h24a24,24,0,0,1,24,24h0a24,24,0,0,1-24,24h0a24,24,0,0,1-24-24Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M104,128h24a0,0,0,0,1,0,0v72a24,24,0,0,1-24,24h0a24,24,0,0,1-24-24V152a24,24,0,0,1,24-24Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M80,128v24a24,24,0,0,1-24,24h0a24,24,0,0,1-24-24h0a24,24,0,0,1,24-24Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path></svg></a></div><div class="w-6"><a href="https://github.com/cjohansen/replicant" title="Replicant on Github"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0 1 12 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"></path></svg></a></div></div></div><div class="p-4 bg-base-200 items-center flex flex-row gap-4 sticky top-0 z-10"><button popovertarget="menu"><svg style="display: inline-block; line-height: 1; height: 24; width: 24;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><line stroke="currentColor" fill="none" stroke-linejoin="round" y1="128" stroke-linecap="round" stroke-width="16" x1="40" y2="128" x2="216"></line><line stroke="currentColor" fill="none" stroke-linejoin="round" y1="64" stroke-linecap="round" stroke-width="16" x1="40" y2="64" x2="216"></line><line stroke="currentColor" fill="none" stroke-linejoin="round" y1="192" stroke-linecap="round" stroke-width="16" x1="40" y2="192" x2="216"></line></svg></button><div id="menu" class="bg-base-200 m-0 px-0 absolute h-full" popover="auto"><aside class="basis-60 shrink-0"><h3 class="text-whitish mb-2 ml-4">Guides</h3><nav class="mb-8"><ol><li><a class="menu-item" href="/hiccup/">Hiccup<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/event-handlers/">Event handlers<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/life-cycle-hooks/">Life-cycle hooks<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/keys/">Keys<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/nil/">Explicit nils<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/alias/">Aliases<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li></ol></nav><h3 class="text-whitish mb-2 ml-4">Tutorials</h3><nav class="mb-8"><ol><li><a class="menu-item" href="/tutorials/tic-tac-toe/">Tic-Tac-Toe<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/routing/">Data-driven routing<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/state-atom/">State management with atoms<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/state-datascript/">State management with Datascript<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><span class="menu-item menu-item-selected">Backend APIs and network<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></span></li><li><a class="menu-item" href="/tutorials/network-reads/">Data-driven queries<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/network-writes/">Data-driven commands<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/tic-tac-toe-alias/">Tic-Tac-Toe with aliases<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/i18n-alias/">Alias powered i18n<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/sortable-table/">A sortable table alias<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li></ol></nav><h3 class="text-whitish mb-2 ml-4">Articles</h3><nav class="mb-8"><ol><li><a class="menu-item" href="/top-down/">Top-down rendering<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/learn/">Learn Replicant<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li></ol></nav></aside></div>Tutorial: Backend APIs and network</div><main class="mt-8 mb-16 mx-4 md:mx-0 fullscreen"><h1 class="h1 dark:text-whitish section-md">Backend APIs and network</h1><div class="prose mt-4 section-md"><p>Most frontend apps need to talk to a backend API over the network to do useful
things. If you’re coming from a component-based framework, you may have been
accustomed to making HTTP requests from components. That isn’t possible when you
render with Replicant, so what can you do? That’s what we’ll explore in this
tutorial.</p>
<p>Because networking is a big topic, this tutorial comes in three parts. The one
you’re reading now gives you a quick and dirty example of hooking a frontend up
to an API. If you have the time and patience for it, I strongly recommend
skipping the rest of this introduction and reading the in-depth ones instead:</p>
<ul>
<li><a href="/tutorials/network-reads/">A data-driven system for network reads</a></li>
<li><a href="/tutorials/network-writes/">A data-driven system for network writes</a></li>
</ul>
<p>These in-depth tutorials give you a system to build on. The quick example
that follows in this introduction will demonstrate the basics of networking in a
<a href="/top-down/">top-down</a> rendered app, but will not scale in any meaningful way.</p>
</div><div class="prose mt-4 section-md"><h2 id="http-top-down" class="h2 section-md"><a class="group relative" href="#http-top-down"><span class="absolute -left-4 group-hover:visible invisible">§ </span>HTTP requests in a top-down world</a></h2><p>The setup for this tutorial is based on <a href="/tutorials/state-atom/">the state management with an atom
tutorial</a>, including the routing extension and a small
backend. If you want to follow along, grab <a href="https://github.com/cjohansen/replicant-networking/tree/setup">the setup on
Github</a>, and
follow the README to get running.</p>
<p>In this quick tutorial we want to fire off an HTTP request and render the
results in our UI. So the first decision is: how to trigger the request? Well,
the setup has a system for triggering actions from DOM events, so let’s create
one that makes an HTTP request.</p>
<p>From the <a href="/tutorials/state-atom/">state management with an atom tutorial</a> we
have an action dispatch in <code>execute-actions</code>, let’s add a new entry here:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">execute-actions</span> <span class="p">[</span><span class="nv">store</span> <span class="nv">actions</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">doseq </span><span class="p">[[</span><span class="nv">action</span> <span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span> <span class="nv">actions</span><span class="p">]</span>
    <span class="p">(</span><span class="nf">case</span> <span class="nv">action</span>
      <span class="ss">:store/assoc-in</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">swap!</span> <span class="nv">store</span> <span class="nv">assoc-in</span> <span class="nv">args</span><span class="p">)</span>
      <span class="ss">:backend/fetch-todo-items</span> <span class="p">(</span><span class="nf">fetch-todo-items</span> <span class="nv">store</span><span class="p">)</span>         <span class="c1">;; &lt;==</span>
      <span class="p">(</span><span class="nb">println </span><span class="s">"Unknown action"</span> <span class="nv">action</span> <span class="s">"with arguments"</span> <span class="nv">args</span><span class="p">))))</span>
</code></pre>
<p>Since the store atom is the app’s only source of data, information about the
network request also needs to go in here. The first bit of information is that
the request is underway. We can use this to mark the UI as loading:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">fetch-todo-items</span> <span class="p">[</span><span class="nv">store</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">swap!</span> <span class="nv">store</span> <span class="nb">assoc </span><span class="ss">:loading-todos?</span> <span class="nv">true</span><span class="p">))</span>
</code></pre>
<p>With this in place, we can already try the action from the UI:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">render-frontpage</span> <span class="p">[</span><span class="nv">state</span><span class="p">]</span>
  <span class="p">[</span><span class="ss">:main.p-8.max-w-screen-lg</span>
   <span class="p">[</span><span class="ss">:h1.text-2xl.mb-4</span> <span class="s">"Toil and trouble: Todos over the network"</span><span class="p">]</span>
   <span class="p">[</span><span class="ss">:button.btn.btn-primary</span>
    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="ss">:loading-todos?</span> <span class="nv">state</span><span class="p">)</span>
      <span class="p">{</span><span class="ss">:disabled</span> <span class="nv">true</span><span class="p">}</span>
      <span class="p">{</span><span class="ss">:on</span> <span class="p">{</span><span class="ss">:click</span> <span class="p">[[</span><span class="ss">:backend/fetch-todo-items</span><span class="p">]]}})</span>
    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="ss">:loading-todos?</span> <span class="nv">state</span><span class="p">)</span>
      <span class="p">[</span><span class="ss">:span.loading.loading-spinner</span><span class="p">])</span>
    <span class="s">"Fetch todos"</span><span class="p">]])</span>
</code></pre>
<p>Clicking this button will re-render it disabled with a spinner. Not much more
will happen, though. The next step is to make the HTTP request. The backend has
a <code>/query</code> endpoint that supports a query for the todo items, and we can use
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch"><code>fetch</code></a>
to post to it:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">fetch-todo-items</span> <span class="p">[</span><span class="nv">store</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">swap!</span> <span class="nv">store</span> <span class="nb">assoc </span><span class="ss">:loading-todos?</span> <span class="nv">true</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">js/fetch</span> <span class="s">"/query"</span> <span class="o">#</span><span class="nv">js</span> <span class="p">{</span><span class="ss">:method</span> <span class="s">"post"</span>
                          <span class="ss">:body</span> <span class="p">(</span><span class="nb">pr-str </span><span class="p">{</span><span class="ss">:query/kind</span> <span class="ss">:query/todo-items</span><span class="p">})}))</span>
</code></pre>
<p><code>fetch</code> returns a promise. We will store the response in the state atom as well:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">receive-todo-items</span> <span class="p">[</span><span class="nv">state</span> <span class="nv">response</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">cond-&gt;</span> <span class="p">(</span><span class="nb">dissoc </span><span class="nv">state</span> <span class="ss">:loading-todos?</span><span class="p">)</span>
    <span class="p">(</span><span class="ss">:success?</span> <span class="nv">response</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">assoc </span><span class="ss">:todo-items</span> <span class="p">(</span><span class="ss">:result</span> <span class="nv">response</span><span class="p">))</span>

    <span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="ss">:success?</span> <span class="nv">response</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">assoc </span><span class="ss">:error</span> <span class="s">"Failed to load todos"</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">fetch-todo-items</span> <span class="p">[</span><span class="nv">store</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">swap!</span> <span class="nv">store</span> <span class="nb">assoc </span><span class="ss">:loading-todos?</span> <span class="nv">true</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">js/fetch</span> <span class="s">"/query"</span> <span class="o">#</span><span class="nv">js</span> <span class="p">{</span><span class="ss">:method</span> <span class="s">"post"</span>
                              <span class="ss">:body</span> <span class="p">(</span><span class="nb">pr-str </span><span class="p">{</span><span class="ss">:query/kind</span> <span class="ss">:query/todo-items</span><span class="p">})})</span>
      <span class="p">(</span><span class="nf">.then</span> <span class="o">#</span><span class="p">(</span><span class="nf">.text</span> <span class="nv">%</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">.then</span> <span class="o">#</span><span class="p">(</span><span class="nf">swap!</span> <span class="nv">store</span> <span class="nv">receive-todo-items</span> <span class="p">(</span><span class="nf">reader/read-string</span> <span class="nv">%</span><span class="p">)))))</span>
</code></pre>
<p>When receiving a response we also remove the <code>:loading-todos?</code> key. Note that we
didn’t handle HTTP errors such as a broken connection. To do so, add a <code>.catch</code>
to the promise and swap in an error.</p>
<p>The render function can now render the data when available:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">render-frontpage</span> <span class="p">[</span><span class="nv">state</span><span class="p">]</span>
  <span class="p">[</span><span class="ss">:main.p-8.max-w-screen-lg</span>
   <span class="p">[</span><span class="ss">:h1.text-2xl.mb-4</span> <span class="s">"Toil and trouble: Todos over the network"</span><span class="p">]</span>
   <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">todos</span> <span class="p">(</span><span class="ss">:todo-items</span> <span class="nv">state</span><span class="p">)]</span>
     <span class="p">[</span><span class="ss">:ul.mb-4</span>
      <span class="p">(</span><span class="nb">for </span><span class="p">[</span><span class="nv">item</span> <span class="nv">todos</span><span class="p">]</span>
        <span class="p">[</span><span class="ss">:li.my-2</span>
         <span class="p">[</span><span class="ss">:span.pr-2</span>
          <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="ss">:todo/done?</span> <span class="nv">item</span><span class="p">)</span>
            <span class="s">"✓"</span>
            <span class="s">"▢"</span><span class="p">)]</span>
         <span class="p">(</span><span class="ss">:todo/title</span> <span class="nv">item</span><span class="p">)])])</span>
   <span class="p">[</span><span class="ss">:button.btn.btn-primary</span>
    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="ss">:loading-todos?</span> <span class="nv">state</span><span class="p">)</span>
      <span class="p">{</span><span class="ss">:disabled</span> <span class="nv">true</span><span class="p">}</span>
      <span class="p">{</span><span class="ss">:on</span> <span class="p">{</span><span class="ss">:click</span> <span class="p">[[</span><span class="ss">:backend/fetch-todo-items</span><span class="p">]]}})</span>
    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="ss">:loading-todos?</span> <span class="nv">state</span><span class="p">)</span>
      <span class="p">[</span><span class="ss">:span.loading.loading-spinner</span><span class="p">])</span>
    <span class="s">"Fetch todos"</span><span class="p">]])</span>
</code></pre>
<p>If you click the button, the list should appear. In fact, the list will likely
appear so fast you can’t even see the loading state. Because of this,
intermittent states like these can be hard to work with. Fortunately, the UI is
a pure function, so we can just call it with the right data to trigger the
loading view:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">(</span><span class="nf">render-frontpage</span> <span class="p">{</span><span class="ss">:loading-todos?</span> <span class="nv">true</span><span class="p">})</span>
</code></pre>
<p>You can do this in something like
<a href="https://github.com/cjohansen/portfolio">Portfolio</a> for a visual inspection,
just like we did in <a href="/tutorials/tic-tac-toe/">the Tic Tac Toe tutorial</a>. You can
also do it in a unit test. Isn’t functional programming great?</p>
</div><div class="prose mt-4 section-md"><h2 id="next-step" class="h2 section-md"><a class="group relative" href="#next-step"><span class="absolute -left-4 group-hover:visible invisible">§ </span>Next step</a></h2><p>So that’s it: a very quick and dirty way to add an HTTP request to a top-down
rendered app. But our solution leaves a lot to be desired: the action is
specific to a single API call. Adding more would mean copy-pasting a lot of
imperative code in the core namespace, and you’d end up with a lot of more or
less randomly named keys to juggle in the state atom.</p>
<p>A better solution, <a href="/top-down/#system-design">alluded to</a> in the top-down
article, is to provide some central infrastructure for all your HTTP needs. By
generalizing the solution a little we could make it so new API calls can be
added without writing a single line of imperative code. That’s exactly what we
do in <a href="/tutorials/network-reads/">the more in-depth network reads tutorial</a>.
This tutorial also offers a way to load data as we navigate to specific pages.</p>
<p>The code from this tutorial is available in <a href="https://github.com/cjohansen/replicant-networking/tree/quick-and-dirty">a branch on
Github</a>.</p>
</div></main><script type="text/javascript" src="/bundles/d399b4851ce7/app.js"></script></body></html>