<!DOCTYPE html><html data-theme="dark" lang="en" prefix="og: http://ogp.me/ns#"><head><title>Data-driven commands</title><meta name="theme-color" content="#202020"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta property="og:title" content="Data-driven commands"><link href="/a00f586d252b/favicon.ico" rel="icon" type="image/x-icon"><link href="/a00f586d252b/favicon.ico" rel="shortcut icon" type="image/ico"><link href="/a00f586d252b/favicon.ico" rel="shortcut icon" type="image/x-icon"><link href="/a00f586d252b/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon"><link href="/285191ad6a81/apple-touch-icon.png" rel="icon" type="image/png" sizes="180x180"><link rel="stylesheet" href="/bundles/2e8dfb3c3384/styles.css"></head><body><div class="flex justify-between p-4 items-center"><div class="w-8"><a href="/"><svg style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2" viewBox="0 0 1080 1080" xml:space="preserve"><path d="M876.452 152.555c136.818 12.348 195.668 81.688 192.708 196.198h-87.197c1.569-66.295-16.004-119.066-52.748-157.356-14.398-15.003-31.913-27.882-52.763-38.353v-.489Zm98.715 270.164h87.213c-9.48 55.52-38.53 92.323-91.749 108.344 55.789 39.542 76.849 90.867 66.189 152.957l-44.388 184.981h-86.379l42.751-178.151c.149-.622.278-1.249.386-1.879 9.983-58.16-3.188-108.49-41.722-150.197 36.949-23.921 58.758-61.19 67.282-111.131a29.34 29.34 0 0 0 .417-4.924Z" fill="#4fb348"></path><path d="M757.149 152.309c138.837 11.646 198.514 81.149 195.537 196.444h-88.511c1.643-69.4-17.651-123.977-58.046-162.647-13.679-13.096-29.954-24.431-48.98-33.797Zm101.023 270.41h87.726c-9.475 55.52-38.529 92.323-91.745 108.344 55.785 39.542 76.848 90.867 66.191 152.957l-44.391 184.981h-87.689l42.752-178.151c.149-.622.278-1.249.386-1.879 9.983-58.16-3.188-108.49-41.722-150.197 36.948-23.921 58.758-61.19 67.281-111.131.153-.894.263-1.79.332-2.685h.506c.126-.747.25-1.493.373-2.239Z" fill="#00a29a"></path><path d="M76.208 847.157c-36.752-5.562-64.959-37.32-64.959-75.614 0-42.21 34.269-76.478 76.478-76.478a76.45 76.45 0 0 1 20.676 2.832c32.178 9.028 55.802 38.6 55.802 73.646 0 42.209-34.268 76.478-76.478 76.478-3.915 0-7.761-.295-11.519-.864Zm56.524-262.05a77.324 77.324 0 0 1-6.804.299c-42.209 0-76.478-34.268-76.478-76.478 0-42.209 34.269-76.478 76.478-76.478 13.663 0 26.494 3.591 37.6 9.879 23.204 13.139 38.878 38.053 38.878 66.599 0 39.917-30.647 72.732-69.674 76.179Zm-18.148 84.136 11.77-54.569c58.168-.23 105.321-47.525 105.321-105.746 0-35.555-17.586-67.035-44.526-86.209H828.11c-9.475 55.52-38.529 92.323-91.745 108.344 55.784 39.542 76.848 90.867 66.191 152.957l-44.391 184.981H539.756l34.836-151.189c13.135-57.004-4.455-118.062-91.882-118.062H353.796l-71.217 274.677H112.245c46.557-11.07 81.229-52.96 81.229-102.884 0-49.085-33.515-90.403-78.89-102.3Zm-1.803-330.67 117.483-187.485h389.845c152.584 6.696 217.9 77.175 214.789 197.665H178.595v-10.18h-65.814Z" fill="#0086ff"></path></svg></a></div><div class="flex items-center gap-4 text-sm"><a class="hover:underline" href="/learn/">Learn</a><a class="hover:underline" href="https://cljdoc.org/d/no.cjohansen/replicant/">API Reference</a><div class="w-6"><a href="https://clojurians.slack.com/archives/C06JZ4X334N" title="Replicant on the Clojurians Slack"><svg style="display: inline-block; line-height: 1;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><path d="M80,56h24a0,0,0,0,1,0,0v72a24,24,0,0,1-24,24h0a24,24,0,0,1-24-24V80A24,24,0,0,1,80,56Z" transform="translate(184 24) rotate(90)" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M128,80H104A24,24,0,0,1,80,56h0a24,24,0,0,1,24-24h0a24,24,0,0,1,24,24Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M152,32h24a0,0,0,0,1,0,0v72a24,24,0,0,1-24,24h0a24,24,0,0,1-24-24V56a24,24,0,0,1,24-24Z" transform="translate(304 160) rotate(-180)" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M176,128V104a24,24,0,0,1,24-24h0a24,24,0,0,1,24,24h0a24,24,0,0,1-24,24Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M176,104h24a0,0,0,0,1,0,0v72a24,24,0,0,1-24,24h0a24,24,0,0,1-24-24V128a24,24,0,0,1,24-24Z" transform="translate(24 328) rotate(-90)" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M128,176h24a24,24,0,0,1,24,24h0a24,24,0,0,1-24,24h0a24,24,0,0,1-24-24Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M104,128h24a0,0,0,0,1,0,0v72a24,24,0,0,1-24,24h0a24,24,0,0,1-24-24V152a24,24,0,0,1,24-24Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M80,128v24a24,24,0,0,1-24,24h0a24,24,0,0,1-24-24h0a24,24,0,0,1,24-24Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path></svg></a></div><div class="w-6"><a href="https://github.com/cjohansen/replicant" title="Replicant on Github"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0 1 12 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"></path></svg></a></div></div></div><div class="p-4 bg-base-200 items-center flex flex-row gap-4 sticky top-0 z-10"><button popovertarget="menu"><svg style="display: inline-block; line-height: 1; height: 24; width: 24;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><line stroke="currentColor" fill="none" stroke-linejoin="round" y1="128" stroke-linecap="round" stroke-width="16" x1="40" y2="128" x2="216"></line><line stroke="currentColor" fill="none" stroke-linejoin="round" y1="64" stroke-linecap="round" stroke-width="16" x1="40" y2="64" x2="216"></line><line stroke="currentColor" fill="none" stroke-linejoin="round" y1="192" stroke-linecap="round" stroke-width="16" x1="40" y2="192" x2="216"></line></svg></button><div id="menu" class="bg-base-200 m-0 px-0 absolute h-full" popover="auto"><aside class="basis-60 shrink-0"><h3 class="text-whitish mb-2 ml-4">Guides</h3><nav class="mb-8"><ol><li><a class="menu-item" href="/hiccup/">Hiccup<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/event-handlers/">Event handlers<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/life-cycle-hooks/">Life-cycle hooks<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/keys/">Keys<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/nil/">Explicit nils<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/alias/">Aliases<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li></ol></nav><h3 class="text-whitish mb-2 ml-4">Tutorials</h3><nav class="mb-8"><ol><li><a class="menu-item" href="/tutorials/tic-tac-toe/">Tic-Tac-Toe<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/routing/">Data-driven routing<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/state-atom/">State management with atoms<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/state-datascript/">State management with Datascript<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/network/">Backend APIs and network<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/network-reads/">Data-driven queries<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><span class="menu-item menu-item-selected">Data-driven commands<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></span></li><li><a class="menu-item" href="/tutorials/tic-tac-toe-alias/">Tic-Tac-Toe with aliases<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/i18n-alias/">Alias powered i18n<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/tutorials/sortable-table/">A sortable table alias<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li></ol></nav><h3 class="text-whitish mb-2 ml-4">Articles</h3><nav class="mb-8"><ol><li><a class="menu-item" href="/top-down/">Top-down rendering<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li><li><a class="menu-item" href="/learn/">Learn Replicant<svg style="display: inline-block; line-height: 1; height: 16; width: 16;" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg></a></li></ol></nav></aside></div>Tutorial: Data-driven commands</div><main class="mt-8 mb-16 mx-4 md:mx-0 fullscreen"><h1 class="h1 dark:text-whitish section-md">Data-driven commands</h1><div class="prose mt-4 section-md"><p>In this second part of the <a href="/tutorials/network/">networking tutorial</a>, we will
build a data-driven system for writing data over the network.</p>
<p>We pick up where <a href="/tutorials/network-reads/">data-driven network reads</a> left
off, and the setup is the code we wrote there. The starting point is available
as <a href="https://github.com/cjohansen/replicant-networking/tree/network-reads">a branch on
Github</a>.</p>
</div><div class="prose mt-4 section-md"><h2 id="design" class="h2 section-md"><a class="group relative" href="#design"><span class="absolute -left-4 group-hover:visible invisible">§ </span>Design goal</a></h2><p>To perform writes over the network, we will follow a very similar design to the
one we developed when reading over the network. Reading and writing really is
quite similar, but we want slightly more pointed write semantics.</p>
<p>Since we already have a dedicated mechanism for reading data, we want to avoid
writes becoming a secondary read channel. For this reason, writes will only
result in success or error, and possibly novelty such as newly created ids. In
other words, we will not return newly created entities from writes. Instead
we’ll add a mechanism for reloading data after performing writes.</p>
<p>Network reads were dubbed queries. We will refer to writes as commands. Just
like with queries, we will use a data structure to talk about commands in the
frontend, but it is up to you if you want your backend to support these commands
natively, or if you will translate commands to some REST API request or similar.</p>
<p>The data structure for commands is very similar to the one we made for queries:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">{</span><span class="ss">:command/kind</span> <span class="ss">:command/create-todo</span>
 <span class="ss">:command/data</span> <span class="p">{</span><span class="ss">:todo/title</span> <span class="s">"Implement commands"</span><span class="p">}}</span>
</code></pre>
</div><div class="prose mt-4 section-md"><h2 id="questions" class="h2 section-md"><a class="group relative" href="#questions"><span class="absolute -left-4 group-hover:visible invisible">§ </span>Answering questions</a></h2><p>Just like we did for queries, we’ll keep a log for commands, and write a few
functions to answer some important questions. The details of these are very
similar to the ones in the reads tutorial, so I’ll point you to <a href="https://github.com/cjohansen/replicant-networking/tree/network-writes">the
code</a> for
details.</p>
<p>This test sums up the gist of it:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">(</span><span class="nf">testing</span> <span class="s">"Received successful response"</span>
  <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nf">false?</span>
       <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">command/issue-command</span> <span class="p">{}</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">"2025-01-02T06:44:13"</span> <span class="nv">command</span><span class="p">)</span>
           <span class="p">(</span><span class="nf">command/receive-response</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">"2025-01-02T06:44:13"</span> <span class="nv">command</span> <span class="p">{</span><span class="ss">:success?</span> <span class="nv">true</span><span class="p">})</span>
           <span class="p">(</span><span class="nf">command/issued?</span> <span class="nv">command</span><span class="p">)))))</span>
</code></pre>
</div><div class="prose mt-4 section-md"><h2 id="http-requests" class="h2 section-md"><a class="group relative" href="#http-requests"><span class="absolute -left-4 group-hover:visible invisible">§ </span>Making HTTP requests</a></h2><p>Once again, refer to <a href="/tutorials/network-reads/#http-requests">the query
tutorial</a> for a discussion about how to
map the client-side commands to your specific backend API. The sample app has a
<code>/command</code> endpoint that can take commands directly.</p>
<p>We can start with basically the exact same function as last time, only changing
“query” to “command”:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">issue-command</span> <span class="p">[</span><span class="nv">store</span> <span class="nv">command</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">swap!</span> <span class="nv">store</span> <span class="nv">command/issue-command</span> <span class="p">(</span><span class="nf">js/Date.</span><span class="p">)</span> <span class="nv">command</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">js/fetch</span> <span class="s">"/command"</span> <span class="o">#</span><span class="nv">js</span> <span class="p">{</span><span class="ss">:method</span> <span class="s">"POST"</span>
                                <span class="ss">:body</span> <span class="p">(</span><span class="nb">pr-str </span><span class="nv">command</span><span class="p">)})</span>
      <span class="p">(</span><span class="nf">.then</span> <span class="o">#</span><span class="p">(</span><span class="nf">.text</span> <span class="nv">%</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">.then</span> <span class="nv">reader/read-string</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">.then</span> <span class="o">#</span><span class="p">(</span><span class="nf">swap!</span> <span class="nv">store</span> <span class="nv">command/receive-response</span> <span class="p">(</span><span class="nf">js/Date.</span><span class="p">)</span> <span class="nv">command</span> <span class="nv">%</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">.catch</span> <span class="o">#</span><span class="p">(</span><span class="nf">swap!</span> <span class="nv">store</span> <span class="nv">command/receive-response</span> <span class="p">(</span><span class="nf">js/Date.</span><span class="p">)</span> <span class="nv">command</span> <span class="p">{</span><span class="ss">:error</span>
      <span class="p">(</span><span class="nf">.-message</span> <span class="nv">%</span><span class="p">)}))))</span>
</code></pre>
<p>This will allow us to issue commands. But since we decided to not mix reads with
writes, we need a way to trigger a refresh of the data after issuing some
commands. To do this, we will allow command actions to include actions to
perform on successful completion of the command (phew!). It will look like this:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">[[</span><span class="ss">:data/command</span>
  <span class="p">{</span><span class="ss">:command/kind</span> <span class="ss">:command/toggle-todo</span>
   <span class="ss">:command/data</span> <span class="p">{</span><span class="ss">:todo/id</span> <span class="s">"ac564c"</span><span class="p">}}</span>
  <span class="p">{</span><span class="ss">:on-success</span> <span class="p">[[</span><span class="ss">:data/query</span> <span class="nv">items-query</span><span class="p">]]}]]</span>
</code></pre>
<p>To support this, we need to declare <code>execute-actions</code>, since we want to call it
from a function that is itself called from <code>execute-actions</code>:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">(</span><span class="kd">declare </span><span class="nv">execute-actions</span><span class="p">)</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">issue-command</span> <span class="p">[</span><span class="nv">store</span> <span class="nv">command</span> <span class="o">&amp;</span> <span class="p">[{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">on-success</span><span class="p">]}]]</span>
  <span class="p">(</span><span class="nf">swap!</span> <span class="nv">store</span> <span class="nv">command/issue-command</span> <span class="p">(</span><span class="nf">js/Date.</span><span class="p">)</span> <span class="nv">command</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">js/fetch</span> <span class="s">"/command"</span> <span class="o">#</span><span class="nv">js</span> <span class="p">{</span><span class="ss">:method</span> <span class="s">"POST"</span>
                                <span class="ss">:body</span> <span class="p">(</span><span class="nb">pr-str </span><span class="nv">command</span><span class="p">)})</span>
      <span class="p">(</span><span class="nf">.then</span> <span class="o">#</span><span class="p">(</span><span class="nf">.text</span> <span class="nv">%</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">.then</span> <span class="nv">reader/read-string</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">.then</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">res</span><span class="p">]</span>
               <span class="p">(</span><span class="nf">swap!</span> <span class="nv">store</span> <span class="nv">command/receive-response</span>
                            <span class="p">(</span><span class="nf">js/Date.</span><span class="p">)</span> <span class="nv">command</span> <span class="nv">res</span><span class="p">)</span>
               <span class="p">(</span><span class="nb">when </span><span class="nv">on-success</span>
                 <span class="p">(</span><span class="nf">execute-actions</span> <span class="nv">store</span> <span class="nv">on-success</span><span class="p">))))</span>
      <span class="p">(</span><span class="nf">.catch</span> <span class="o">#</span><span class="p">(</span><span class="nf">swap!</span> <span class="nv">store</span> <span class="nv">command/receive-response</span>
                            <span class="p">(</span><span class="nf">js/Date.</span><span class="p">)</span> <span class="nv">command</span> <span class="p">{</span><span class="ss">:error</span> <span class="p">(</span><span class="nf">.-message</span> <span class="nv">%</span><span class="p">)}))))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">execute-actions</span> <span class="p">[</span><span class="nv">store</span> <span class="nv">actions</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">doseq </span><span class="p">[[</span><span class="nv">action</span> <span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span> <span class="nv">actions</span><span class="p">]</span>
    <span class="p">(</span><span class="nf">case</span> <span class="nv">action</span>
      <span class="ss">:store/assoc-in</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">swap!</span> <span class="nv">store</span> <span class="nv">assoc-in</span> <span class="nv">args</span><span class="p">)</span>
      <span class="ss">:data/query</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">query-backend</span> <span class="nv">store</span> <span class="nv">args</span><span class="p">)</span>
      <span class="ss">:data/command</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">issue-command</span> <span class="nv">store</span> <span class="nv">args</span><span class="p">)</span>             <span class="c1">;; &lt;==</span>
      <span class="p">(</span><span class="nb">println </span><span class="s">"Unknown action"</span> <span class="nv">action</span> <span class="s">"with arguments"</span> <span class="nv">args</span><span class="p">))))</span>
</code></pre>
</div><div class="prose mt-4 section-md"><h2 id="issuing-commands" class="h2 section-md"><a class="group relative" href="#issuing-commands"><span class="absolute -left-4 group-hover:visible invisible">§ </span>Issuing commands</a></h2><p>With our new command action in place, we can make todo items togglable on the
frontpage:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">(</span><span class="kd">ns </span><span class="nv">toil.frontpage</span>
  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">toil.command</span> <span class="ss">:as</span> <span class="nv">command</span><span class="p">]</span>
            <span class="p">[</span><span class="nv">toil.query</span> <span class="ss">:as</span> <span class="nv">query</span><span class="p">]))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">items-query</span>
  <span class="p">{</span><span class="ss">:query/kind</span> <span class="ss">:query/todo-items</span><span class="p">})</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">render</span> <span class="p">[</span><span class="nv">state</span><span class="p">]</span>
  <span class="p">[</span><span class="ss">:main.p-8.max-w-screen-lg</span>
   <span class="p">[</span><span class="ss">:h1.text-2xl.mb-4</span> <span class="s">"Toil and trouble: Todos over the network"</span><span class="p">]</span>
   <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">todos</span> <span class="p">(</span><span class="nf">query/get-result</span> <span class="nv">state</span> <span class="nv">items-query</span><span class="p">)]</span>
     <span class="p">[</span><span class="ss">:ul.mb-4</span>
      <span class="p">(</span><span class="nb">for </span><span class="p">[</span><span class="nv">item</span> <span class="nv">todos</span><span class="p">]</span>
        <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">command</span> <span class="p">{</span><span class="ss">:command/kind</span> <span class="ss">:command/toggle-todo</span>
                       <span class="ss">:command/data</span> <span class="nv">item</span><span class="p">}]</span>
          <span class="p">[</span><span class="ss">:li.my-2</span>
           <span class="p">[</span><span class="ss">:button.cursor-pointer</span>
            <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">command/issued?</span> <span class="nv">state</span> <span class="nv">command</span><span class="p">)</span>
              <span class="p">{</span><span class="ss">:disabled</span> <span class="nv">true</span><span class="p">}</span>
              <span class="p">{</span><span class="ss">:on</span> <span class="p">{</span><span class="ss">:click</span>
                    <span class="p">[[</span><span class="ss">:data/command</span> <span class="nv">command</span>
                      <span class="p">{</span><span class="ss">:on-success</span> <span class="p">[[</span><span class="ss">:data/query</span> <span class="nv">items-query</span><span class="p">]]}]]}})</span>
            <span class="p">[</span><span class="ss">:span.pr-2</span>
             <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="ss">:todo/done?</span> <span class="nv">item</span><span class="p">)</span>
               <span class="s">"✓"</span>
               <span class="s">"▢"</span><span class="p">)]]</span>
           <span class="p">(</span><span class="ss">:todo/title</span> <span class="nv">item</span><span class="p">)</span>
           <span class="s">" ("</span>
           <span class="p">[</span><span class="ss">:ui/a.link</span>
            <span class="p">{</span><span class="ss">:ui/location</span>
             <span class="p">{</span><span class="ss">:location/page-id</span> <span class="ss">:pages/user</span>
              <span class="ss">:location/params</span> <span class="p">{</span><span class="ss">:user/id</span> <span class="p">(</span><span class="ss">:todo/created-by</span> <span class="nv">item</span><span class="p">)}}}</span>
            <span class="p">(</span><span class="ss">:todo/created-by</span> <span class="nv">item</span><span class="p">)]</span>
           <span class="s">")"</span><span class="p">]))])</span>
   <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">query/loading?</span> <span class="nv">state</span> <span class="nv">items-query</span><span class="p">)</span>
     <span class="p">[</span><span class="ss">:button.btn.btn-primary</span> <span class="p">{</span><span class="ss">:disabled</span> <span class="nv">true</span><span class="p">}</span>
      <span class="p">[</span><span class="ss">:span.loading.loading-spinner</span><span class="p">]</span>
      <span class="s">"Fetching todos"</span><span class="p">]</span>
     <span class="p">[</span><span class="ss">:button.btn.btn-primary</span>
      <span class="p">{</span><span class="ss">:on</span> <span class="p">{</span><span class="ss">:click</span> <span class="p">[[</span><span class="ss">:data/query</span> <span class="nv">items-query</span><span class="p">]]}}</span>
      <span class="s">"Fetch todos"</span><span class="p">])])</span>
</code></pre>
<p>We can now click the box/checkmark next to each item to toggle them back and
forth. And just like with queries, we can now add new commands to our frontend
without writing a single line of imperative code. Pretty nice.</p>
</div><div class="prose mt-4 section-md"><h2 id="issuing-commands-user-input" class="h2 section-md"><a class="group relative" href="#issuing-commands-user-input"><span class="absolute -left-4 group-hover:visible invisible">§ </span>Issuing commands with user input</a></h2><p>As a final task, we will add a input field to input new todos in. For this to
work we need to grab the text from the input and include it in a command.
Luckily, we already added event interpolation in the setup in <a href="/tutorials/state-atom/">the state
management tutorial</a>.</p>
<p>Let’s start by adding the form:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">[</span><span class="ss">:form.flex.gap-4.mb-4</span>
 <span class="p">[</span><span class="ss">:input.input.input-bordered.w-full.max-w-xs</span>
  <span class="p">{</span><span class="ss">:type</span> <span class="s">"text"</span>
   <span class="ss">:placeholder</span> <span class="s">"New todo"</span><span class="p">}]</span>
 <span class="p">[</span><span class="ss">:button.btn.btn-primary</span> <span class="p">{</span><span class="ss">:type</span> <span class="s">"submit"</span><span class="p">}</span>
  <span class="s">"Save todo"</span><span class="p">]]</span>
</code></pre>
<p>To breathe life into this, we will add two actions. The first one will store the
input’s text in the global store on the input event:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">[</span><span class="ss">:input.input.input-bordered.w-full.max-w-xs</span>
 <span class="p">{</span><span class="ss">:type</span> <span class="s">"text"</span>
  <span class="ss">:placeholder</span> <span class="s">"New todo"</span>
  <span class="ss">:value</span> <span class="p">(</span><span class="ss">::todo-title</span> <span class="nv">state</span><span class="p">)</span>
  <span class="ss">:on</span> <span class="p">{</span><span class="ss">:input</span> <span class="p">[[</span><span class="ss">:store/assoc-in</span> <span class="p">[</span><span class="ss">::todo-title</span><span class="p">]</span> <span class="ss">:event/target.value</span><span class="p">]]}}]</span>
</code></pre>
<p>The second one is a click action on the button that will use this value in a
command to create a todo. On successful creation, the input field is emptied and
the todo list is refreshed:</p>
<pre class="codehilite"><code class="language-clj"><span></span><span class="p">(</span><span class="kd">defn </span><span class="nv">render</span> <span class="p">[</span><span class="nv">state</span><span class="p">]</span>
  <span class="p">[</span><span class="ss">:main.p-8.max-w-screen-lg</span>
   <span class="p">[</span><span class="ss">:h1.text-2xl.mb-4</span> <span class="s">"Toil and trouble: Todos over the network"</span><span class="p">]</span>
   <span class="p">[</span><span class="ss">:form.flex.gap-4.mb-4</span>
    <span class="p">[</span><span class="ss">:input.input.input-bordered.w-full.max-w-xs</span>
     <span class="p">{</span><span class="ss">:type</span> <span class="s">"text"</span>
      <span class="ss">:placeholder</span> <span class="s">"New todo"</span>
      <span class="ss">:value</span> <span class="p">(</span><span class="ss">::todo-title</span> <span class="nv">state</span><span class="p">)</span>
      <span class="ss">:on</span> <span class="p">{</span><span class="ss">:input</span> <span class="p">[[</span><span class="ss">:store/assoc-in</span> <span class="p">[</span><span class="ss">::todo-title</span><span class="p">]</span> <span class="ss">:event/target.value</span><span class="p">]]}}]</span>
    <span class="p">[</span><span class="ss">:button.btn.btn-primary</span>
     <span class="p">{</span><span class="ss">:type</span> <span class="s">"button"</span>
      <span class="ss">:on</span>
      <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">title</span> <span class="p">(</span><span class="nf">not-empty</span> <span class="p">(</span><span class="ss">::todo-title</span> <span class="nv">state</span><span class="p">))]</span>
        <span class="p">{</span><span class="ss">:click</span> <span class="p">[[</span><span class="ss">:data/command</span>
                  <span class="p">{</span><span class="ss">:command/kind</span> <span class="ss">:command/create-todo</span>
                   <span class="ss">:command/data</span> <span class="p">{</span><span class="ss">:todo/created-by</span> <span class="s">"alice"</span>
                                  <span class="ss">:todo/title</span> <span class="nv">title</span><span class="p">}}</span>
                  <span class="p">{</span><span class="ss">:on-success</span> <span class="p">[[</span><span class="ss">:store/assoc-in</span> <span class="p">[</span><span class="ss">::todo-title</span><span class="p">]</span> <span class="s">""</span><span class="p">]</span>
                                <span class="p">[</span><span class="ss">:data/query</span> <span class="nv">items-query</span><span class="p">]]}]]})}</span>
     <span class="s">"Save todo"</span><span class="p">]]</span>
   ,,,<span class="p">])</span>
</code></pre>
<p>A better version of this code would use a submit event on the form and a proper
<code>[:button {:type "submit"} ,,,]</code>. Doing so would require some work in
<code>toil.core</code> to be able to <code>.preventDefault</code> the event. You could also do without
the explicit <code>::todo-title</code> in the global store with more interpolation options.</p>
<p>The <a href="https://github.com/cjohansen/replicant-networking">full code is on Github</a>.</p>
</div></main><script type="text/javascript" src="/bundles/d399b4851ce7/app.js"></script></body></html>